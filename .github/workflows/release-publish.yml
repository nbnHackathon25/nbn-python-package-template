name: 3. Build and Release [auto]

on:
  push:
    branches:
      - master

permissions:
  contents: read

jobs:
  verify:
    name: Verify push from release branch
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Check if merged from release branch
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"

          if [[ "$COMMIT_MSG" =~ Merge.*release/v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "Release version detected: $VERSION"
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "Not a release branch merge, skipping"
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: verify
    if: needs.verify.outputs.is_release == 'true'
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version-file: '.python-version'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Setup environment
        run: |
          ./scripts/setup.sh

      - name: Build Python package
        run: |
          ./scripts/build.sh

      - name: Upload build artifact
        id: upload
        uses: actions/upload-artifact@v5
        with:
          path: dist/*
          name: dist

      - uses: actions/attest-build-provenance@v3
        with:
          subject-name: dist
          subject-digest: sha256:${{ steps.upload.outputs.artifact-digest }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: dist
          format: 'cyclonedx-json'
          output-file: sbom.cyclonedx.json
          dependency-snapshot: true

      - name: Attest
        uses: actions/attest-sbom@v3
        with:
          subject-path: 'dist/*.whl, dist/*.tar.gz'
          sbom-path: sbom.cyclonedx.json


      # - name: Publish
      #   run: |
      #     echo "TODO: publish to package index"

  create-tag:
    name: Create Git Tag
    runs-on: ubuntu-latest
    needs: [verify, build]
    if: needs.verify.outputs.is_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if tag already exists
        run: |
          TAG="v${{ needs.verify.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG already exists"
            exit 1
          fi
          echo "Tag $TAG does not exist, proceeding with release"

      - name: Create Git Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ needs.verify.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} "$TAG"

  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [verify, build, create-tag]
    if: needs.verify.outputs.is_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download Artifacts
        uses: actions/download-artifact@v6
        with:
          name: dist
          path: dist/

      - name: Create GitHub Release
        id: create-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.verify.outputs.version }}"
          # Extract changelog section for this version
          if [ -f CHANGELOG.md ]; then
            SECTION=$(awk -v version="$VERSION" '
              BEGIN { found=0 }
              /^## (v)?[0-9]+\.[0-9]+\.[0-9]+/ {
                if (found) exit
                if ($0 ~ "## " version " " || $0 ~ "## v" version " ") { found=1; next }
              }
              found { print }
            ' CHANGELOG.md)
            [ -z "$SECTION" ] && SECTION="Automated release for version $VERSION."
          else
            SECTION="Automated release for version $VERSION."
          fi

          CHANGELOG_JSON=$(printf "%s" "$SECTION" | jq -Rs .)

          RESPONSE=$(curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            -d '{
              "tag_name": "v'"$VERSION"'",
              "name": "v'"$VERSION"'",
              "body": '"$CHANGELOG_JSON"',
              "draft": false,
              "prerelease": false
            }')
          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_ID="${{ steps.create-release.outputs.release_id }}"
          for file in dist/*; do
            NAME=$(basename "$file")
            echo "Uploading $NAME"
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$file" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$NAME"
          done
